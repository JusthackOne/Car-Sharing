# **1 этап. Проектирование доменной модели для системы каршеринга**  

## **1. Описание предметной области**  
**Проблема:** Разработка веб-приложения для аренды автомобилей, где пользователи могут:  
- Искать автомобили по параметрам (местоположение, дата/время, тип авто, цена).  
- Бронировать и оплачивать аренду.  
- Оставлять отзывы и оценки.  
- Управлять профилем и историей бронирований.  
- Получать уведомления о статусе бронирования.  

**Ключевые бизнес-правила:**  
- Аренда возможна только при подтверждённых водительских правах.  
- Автомобиль нельзя забронировать, если он уже занят или находится в ремонте.  
- Оплата должна быть завершена до начала аренды.  
- Тарифы зависят от модели автомобиля и времени суток.  

---

## **2. Определение сущностей и их атрибутов**  
На основе предоставленной схемы БД выделим ключевые сущности:  

### **1. Пользователь (User)**  
- **Атрибуты:**  
  - `user_id` (ID)  
  - `user_name` (Имя)  
  - **Связанные данные:**  
    - Паспорт (`Passport`)  
    - Водительские права (`Driver_license`)  
    - История поездок (`Trip`)  
    - Платежи (`Payment`)  

### **2. Автомобиль (Car)**  
- **Атрибуты:**  
  - `car_id` (ID)  
  - `mileage` (Пробег)  
  - `licence` (Госномер)  
  - `serial_number` (VIN)  
  - `buying_date` (Дата покупки)  
  - `city` (Город)  
  - `coordinates` (Координаты)  
  - `malfunctions` (Неисправности)  
  - **Связанные данные:**  
    - Модель (`Models`)  
    - Ремонты (`Repairs`)  
    - Поездки (`Trip`)  

### **3. Модель автомобиля (Model)**  
- **Атрибуты:**  
  - `model_id` (ID)  
  - `brand` (Марка)  
  - `model_name` (Модель)  
  - `power` (Мощность)  
  - **Связанные данные:**  
    - Автомобили (`Cars`)  
    - Тарифы (`Tariffs`)  

### **4. Поездка (Trip)**  
- **Атрибуты:**  
  - `trip_id` (ID)  
  - `start_time` (Время начала)  
  - `end_time` (Время окончания)  
  - `problems` (Проблемы во время поездки)  
  - `comments` (Комментарии)  
  - **Связанные данные:**  
    - Автомобиль (`Car`)  
    - Пользователь (`User`)  

### **5. Тариф (Tariff)**  
- **Атрибуты:**  
  - `tariff_id` (ID)  
  - `price_per_minute` (Цена за минуту)  
  - `start_time` (Начало действия тарифа)  
  - `end_time` (Окончание действия тарифа)  
  - **Связанные данные:**  
    - Модель (`Model`)  

### **6. Платеж (Payment)**  
- **Атрибуты:**  
  - `pay_id` (ID)  
  - `description` (Описание)  
  - `value` (Сумма)  
  - `date` (Дата платежа)  
  - `deadline` (Срок оплаты)  
  - `type` (Тип платежа)  
  - **Связанные данные:**  
    - Пользователь (`User`)  

---

## **3. Определение агрегатов и границ консистентности**  

### **Агрегаты и их корневые сущности:**  
1. **`User` (Пользователь)**  
   - Включает: `Passport`, `Driver_license`, `Payment`.  
   - **Правило:** Данные пользователя должны быть консистентны (например, нельзя удалить пользователя, если у него есть активные поездки).  

2. **`Car` (Автомобиль)**  
   - Включает: `Model`, `Repairs`.  
   - **Правило:** Автомобиль нельзя удалить, если он участвует в активной поездке.  

3. **`Trip` (Поездка)**  
   - Включает: `Car`, `User`.  
   - **Правило:** Поездка не может начаться без подтверждённой оплаты.  

4. **`Tariff` (Тариф)**  
   - Включает: `Model`.  
   - **Правило:** Изменение тарифа не должно влиять на текущие поездки.  

---

## **4. Разделение на контексты (Bounded Contexts)**  

| Контекст | Ответственность | Сущности |
|----------|----------------|----------|
| **User Management** | Управление пользователями, паспортными данными, правами | `User`, `Passport`, `Driver_license` |
| **Car Management** | Управление автомобилями, моделями, ремонтами | `Car`, `Model`, `Repairs` |
| **Booking & Trips** | Бронирование, управление поездками | `Trip` |
| **Billing & Tariffs** | Управление тарифами и платежами | `Tariff`, `Payment` |

---

## **5. Связи между контекстами**  

### **Способы коммуникации:**  
1. **User Management → Booking & Trips**  
   - REST API: Проверка прав пользователя перед бронированием.  
2. **Car Management → Booking & Trips**  
   - События (Kafka/RabbitMQ): Уведомление о доступности автомобиля.  
3. **Billing & Tariffs → Booking & Trips**  
   - REST API: Подтверждение оплаты перед началом поездки.  

---

## **6. Доменные сервисы**  

### **Ключевые сервисы:**  
1. **`BookingService`**  
   - Проверяет доступность автомобиля.  
   - Создаёт поездку после оплаты.  
2. **`PaymentService`**  
   - Обрабатывает платежи.  
   - Уведомляет о статусе оплаты.  
3. **`TariffCalculator`**  
   - Рассчитывает стоимость аренды на основе тарифов.  

---

## **7. Примеры доменных сценариев**  

### **Сценарий 1: Бронирование автомобиля**  
1. Пользователь выбирает автомобиль → `BookingService` проверяет доступность.  
2. Система рассчитывает стоимость → `TariffCalculator` применяет тариф.  
3. Пользователь оплачивает → `PaymentService` подтверждает платёж.  
4. Создаётся поездка (`Trip`).  

### **Сценарий 2: Завершение поездки**  
1. Пользователь завершает поездку → система фиксирует `end_time`.  
2. `Billing` выставляет итоговый счёт.  
3. `CarManagement` проверяет состояние автомобиля.  

---

## **8. Диаграммы**  

### **ER-диаграмма (упрощённая)**  
```
User (1) -- (N) Trip  
Car (1) -- (N) Trip  
Model (1) -- (N) Car  
Tariff (1) -- (1) Model  
```

### **Схема контекстов**  
```
[User Management] --(REST)--> [Booking & Trips]  
[Car Management] --(Events)--> [Booking & Trips]  
[Billing & Tariffs] --(REST)--> [Booking & Trips]  
```

---

## **Итог**  
Спроектирована доменная модель системы каршеринга с чёткими контекстами, агрегатами и бизнес-правилами. Модель готова для реализации с учётом DDD.
